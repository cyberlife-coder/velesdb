#!/bin/bash
# =============================================================================
# VelesDB-Core Pre-commit Hook
# =============================================================================
# V√©rifie la qualit√© du code avant chaque commit:
# - Formatage (rustfmt)
# - Linting (clippy)
# - Tests unitaires
# - Audit de s√©curit√©
# =============================================================================

set -e

echo "üîç VelesDB-Core Pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we have staged Rust files
STAGED_RS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

if [ -z "$STAGED_RS_FILES" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  No Rust files staged, skipping Rust checks${NC}"
else
    # 1. Check formatting
    echo -e "\n${YELLOW}üìê Checking formatting...${NC}"
    if ! cargo fmt --all -- --check; then
        echo -e "${RED}‚ùå Formatting check failed. Run 'cargo fmt --all' to fix.${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Formatting OK${NC}"

    # 2. Run clippy
    # Note: -W pedantic (warning) instead of -D (deny) to not block commits on style opinions
    # -D warnings still catches correctness issues
    echo -e "\n${YELLOW}üìé Running clippy...${NC}"
    if ! cargo clippy --all-targets --all-features -- -D warnings -W clippy::pedantic; then
        echo -e "${RED}‚ùå Clippy found issues. Fix them before committing.${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Clippy OK${NC}"

    # 3. Run tests
    echo -e "\n${YELLOW}üß™ Running tests...${NC}"
    if ! cargo test --all-features --lib; then
        echo -e "${RED}‚ùå Tests failed. Fix them before committing.${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Tests OK${NC}"
fi

# 4. Python integration checks (if Python files staged)
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -n "$STAGED_PY_FILES" ]; then
    echo -e "\n${YELLOW}üêç Checking Python integrations...${NC}"
    
    # Check for dangerous hash() usage (exclude docstrings, comments, hashlib)
    DANGEROUS_HASH=$(echo "$STAGED_PY_FILES" | xargs grep -l "hash(" 2>/dev/null | xargs grep -n "hash(" 2>/dev/null | grep -v "hashlib" | grep -v "#.*hash" | grep -v "__hash__" | grep -v '"""' | grep -v "'''" | grep -v "Python's hash" | grep -v "hash()" || true)
    
    if [ -n "$DANGEROUS_HASH" ]; then
        echo -e "${RED}‚ùå Dangerous hash() usage detected in staged Python files:${NC}"
        echo "$DANGEROUS_HASH"
        echo -e "${YELLOW}   Python hash() is non-deterministic across processes.${NC}"
        echo -e "${YELLOW}   Use hashlib.sha256() for IDs/deduplication.${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Python checks OK${NC}"
fi

# 5. Check for secrets (basic check)
echo -e "\n${YELLOW}üîê Checking for potential secrets...${NC}"
if git diff --cached --diff-filter=ACM | grep -iE '(api_key|secret|password|token)\s*=\s*["\x27][^"\x27]+["\x27]' | grep -v '#' | grep -v '//'; then
    echo -e "${RED}‚ùå Potential secret detected in staged changes!${NC}"
    echo -e "${RED}   Please remove secrets before committing.${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ No secrets detected${NC}"

echo -e "\n${GREEN}üéâ All pre-commit checks passed!${NC}\n"
