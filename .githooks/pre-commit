#!/bin/bash
# =============================================================================
# VelesDB-Core Pre-commit Hook
# =============================================================================
# V√©rifie la qualit√© du code avant chaque commit:
# - Formatage (rustfmt)
# - Linting (clippy)
# - Tests unitaires
# - Audit de s√©curit√©
# =============================================================================

set -e

echo "üîç VelesDB-Core Pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we have staged Rust files
STAGED_RS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

if [ -z "$STAGED_RS_FILES" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  No Rust files staged, skipping Rust checks${NC}"
else
    # 1. Check formatting
    echo -e "\n${YELLOW}üìê Checking formatting...${NC}"
    if ! cargo fmt --all -- --check; then
        echo -e "${RED}‚ùå Formatting check failed. Run 'cargo fmt --all' to fix.${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Formatting OK${NC}"

    # 2. Run clippy
    echo -e "\n${YELLOW}üìé Running clippy...${NC}"
    if ! cargo clippy --all-targets --all-features -- -D warnings; then
        echo -e "${RED}‚ùå Clippy found issues. Fix them before committing.${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Clippy OK${NC}"

    # 3. Run tests
    echo -e "\n${YELLOW}üß™ Running tests...${NC}"
    if ! cargo test --all-features --lib; then
        echo -e "${RED}‚ùå Tests failed. Fix them before committing.${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Tests OK${NC}"
fi

# 4. Check for secrets (basic check)
echo -e "\n${YELLOW}üîê Checking for potential secrets...${NC}"
if git diff --cached --diff-filter=ACM | grep -iE '(api_key|secret|password|token)\s*=\s*["\x27][^"\x27]+["\x27]' | grep -v '#' | grep -v '//'; then
    echo -e "${RED}‚ùå Potential secret detected in staged changes!${NC}"
    echo -e "${RED}   Please remove secrets before committing.${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ No secrets detected${NC}"

echo -e "\n${GREEN}üéâ All pre-commit checks passed!${NC}\n"
