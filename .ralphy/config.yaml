# Ralphy Configuration for VelesDB Core
# https://github.com/michaelshimeles/ralphy

project:
  name: "velesdb-core"
  language: "Rust"
  framework: "Workspace (multi-crate)"
  description: "Cognitive memory engine for AI agents - Vector + Graph + Column store with VelesQL"

commands:
  test: "cargo test --workspace"
  lint: "cargo clippy -- -D warnings"
  build: "cargo build --workspace"
  fmt: "cargo fmt --all"
  check: "cargo check --workspace"
  deny: "cargo deny check"
  release: "cargo build --release"
  bench: "cargo bench"
  local_ci: ".\\scripts\\local-ci.ps1"

rules:
  # === TDD OBLIGATOIRE ===
  - "TDD: Write tests BEFORE implementation (RED → GREEN → REFACTOR)"
  - "Tests MUST be in SEPARATE files (module_tests.rs), never inline except for private field access"
  - "Test naming: test_[function]_[scenario]_[expected_result]"
  
  # === RUST QUALITY ===
  - "NEVER use unwrap() on user data - use ? or expect('explicit message')"
  - "NEVER use unsafe without // SAFETY: comment explaining invariants"
  - "Prefer &str over String in function parameters"
  - "Use try_from() with bounds check instead of 'as u32' truncating casts"
  - "Use total_cmp() for float comparison, never partial_cmp().unwrap()"
  - "Use saturating_sub/add for counters to prevent overflow/underflow"
  - "clone() in hot-path MUST be justified with comment"
  
  # === ARCHITECTURE ===
  - "Files > 500 lines = IMMEDIATE refactoring (Martin Fowler tiny steps)"
  - "One module = one responsibility (SOLID)"
  - "DRY: Factor out code duplicated > 3 times"
  - "No premature abstraction (YAGNI)"
  
  # === METRIC-AWARE PATTERN ===
  - "NEVER hardcode distance calculations - always use collection's DistanceMetric"
  - "ORDER BY similarity() DESC = always 'most similar first' regardless of metric type"
  
  # === ERROR HANDLING ===
  - "NEVER silently recover from errors - always log warnings on fallback"
  - "Return clear errors for unsupported query patterns instead of silent incorrect results"
  
  # === GIT WORKFLOW ===
  - "Branch from develop, never commit directly to main or develop"
  - "Branch naming: feature/EPIC-XXX-US-YYY-description"
  - "Commit format: type(scope): description [EPIC-XXX/US-YYY]"
  - "Run local-ci.ps1 BEFORE any push to origin"
  
  # === VALIDATION PRE-COMMIT ===
  - "cargo fmt --all && cargo clippy -- -D warnings && cargo test --workspace && cargo deny check"
  - "0 warnings, 0 dead code, 0 unused imports"
  
  # === CONCURRENCY ===
  - "GPU tests MUST have #[serial(gpu)] to prevent wgpu deadlocks"
  - "Lock ordering: vectors → layers → neighbors"
  - "No blocking syscalls in async context - use spawn_blocking"
  
  # === WASM SPECIFIC ===
  - "NEVER use async constructors in wasm-bindgen - separate new() sync and init() async"
  - "Internal methods in separate impl block (not #[wasm_bindgen]) for Rust access"
  - "Namespaced keys for IndexedDB multi-graph storage"
  
  # === DOCUMENTATION ===
  - "Document public functions with ///"
  - "Update CHANGELOG.md for any feature/fix"
  - "Update progress.md after each US completion"

boundaries:
  never_touch:
    - "Cargo.lock"
    - ".git/**"
    - "target/**"
    - "benchmarks/results/**"
    - "docs/benchmarks/*.png"
    - "velesdb_icon_pack/**"
    - ".github/workflows/**"
