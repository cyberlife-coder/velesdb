# üìã Plan S√©curis√© v0.9.0 - FT-1 + RF-2

**Date**: 2026-01-03  
**Version cible**: v0.9.0  
**Auteurs**: Panel 7 Experts  
**Scope**: `crates/velesdb-core/src/index/hnsw/`

---

## üìä √âtat Actuel (v0.8.5)

### Actions Compl√©t√©es

| ID | Description | Version | Status |
|----|-------------|---------|--------|
| QW-1 | `DistanceMetric::sort_results()` | ‚â§ v0.8.1 | ‚úÖ |
| QW-2 | `simd::prefetch_vector()` | ‚â§ v0.8.1 | ‚úÖ |
| RF-1 | `HnswInner` impl block | ‚â§ v0.8.1 | ‚úÖ |
| PERF-1 | Jaccard/Hamming SIMD | v0.8.2 | ‚úÖ |
| P1-GPU-1 | GPU brute-force search | v0.8.3 | ‚úÖ |
| P2-GPU-2 | GPU euclidean/dot shaders | v0.8.3 | ‚úÖ |
| FT-2 | Tests proptest | v0.8.4 | ‚úÖ |
| FT-3 | Benchmarks CI | v0.8.1 | ‚úÖ |
| **RF-3** | Buffer reuse brute-force | **v0.8.5** | ‚úÖ |

### M√©triques Actuelles

| M√©trique | Valeur | Target v0.9 |
|----------|--------|-------------|
| `index.rs` lignes | ~2800 | <500 (core) |
| Tests total | 657 | 680+ |
| Couverture proptest | 6 propri√©t√©s | 10+ |
| Score audit | 7.2/10 | 8.5/10 |

---

## üéØ Actions v0.9.0

### FT-1: Trait `HnswBackend` pour Abstraction

**Objectif**: D√©coupler `HnswIndex` de la biblioth√®que `hnsw_rs` pour permettre:
- Remplacement futur du backend
- Tests unitaires avec mock backend
- Meilleure testabilit√©

### RF-2: Split `index.rs` en Sous-Modules

**Objectif**: R√©duire la complexit√© du fichier `index.rs` (~2800 lignes) en le d√©coupant en modules coh√©rents.

---

## üîí Analyse de Risques (7 Experts)

### üèóÔ∏è Expert 1 - Architecte

| Risque | Impact | Probabilit√© | Mitigation |
|--------|--------|-------------|------------|
| Imports circulaires apr√®s split | üî¥ Haute | Moyenne | D√©finir hi√©rarchie stricte |
| Visibilit√© `pub(crate)` cass√©e | üü° Moyenne | Haute | Audit visibilit√© AVANT split |
| Breaking changes API | üî¥ Haute | Faible | Conserver API publique identique |

**Ordre obligatoire**: FT-1 **AVANT** RF-2 (le trait facilite le d√©coupage)

### ‚ö° Expert 2 - Performance

| Risque | Impact | Mitigation |
|--------|--------|------------|
| Inline perdu cross-module | üî¥ Haute | `#[inline]` explicite sur hot paths |
| Virtual dispatch overhead | üü° Moyenne | Benchmarks trait vs enum |
| LTO moins efficace | üü¢ Faible | V√©rifier `-C lto=fat` |

**Seuils de r√©gression**:
- Search latency: **¬±3%** max
- Insert latency: **¬±5%** max
- Recall@10: **0%** r√©gression (BLOCKER)

### üîí Expert 3 - Security & Concurrency

**‚ö†Ô∏è R√àGLE CRITIQUE**:
```
impl Drop for HnswIndex NE DOIT JAMAIS quitter index.rs
```

Le pattern `ManuallyDrop` avec lifetime extension `'static` est sensible √† l'ordre de drop.

| Risque | Mitigation |
|--------|------------|
| Drop order cass√© | Drop impl reste dans index.rs |
| Deadlock nouveaux locks | Tests stress concurrence |

### üìê Expert 4 - Clean Code

**Pr√©requis AVANT RF-2**:
1. ‚úÖ RF-1 (HnswInner impl) - D√©j√† fait
2. ‚è≥ FT-1 (Trait Backend) - √Ä faire
3. Cr√©er accesseurs `pub(super)` pour champs priv√©s

### üß™ Expert 5 - Test Engineer

**Tests de garde obligatoires**:
```rust
#[cfg(test)]
mod regression_guards {
    #[test]
    fn guard_api_surface_unchanged() {
        // V√©rifie toutes m√©thodes publiques
    }
    
    #[test]
    fn guard_drop_order_safe() {
        // Stress test create/drop cycles
    }
    
    #[test]
    fn guard_search_results_identical() {
        // Compare avant/apr√®s refactoring
    }
}
```

### üìö Expert 6 - Documentation

Chaque nouveau module doit avoir:
- `//!` module doc en t√™te
- `///` sur chaque item public
- Exemples `rust,ignore` si applicable

### üîß Expert 7 - Maintenabilit√©

**Structure cible RF-2**:
```
src/index/hnsw/
‚îú‚îÄ‚îÄ mod.rs              // Re-exports publics (50L)
‚îú‚îÄ‚îÄ index.rs            // HnswIndex struct + Drop (400L)
‚îú‚îÄ‚îÄ inner.rs            // HnswInner enum (100L)  
‚îú‚îÄ‚îÄ backend.rs          // Trait HnswBackend (FT-1) (80L)
‚îú‚îÄ‚îÄ search.rs           // search_* methods (450L)
‚îú‚îÄ‚îÄ batch.rs            // batch operations (200L)
‚îú‚îÄ‚îÄ persistence.rs      // save/load (150L)
‚îú‚îÄ‚îÄ params.rs           // (existant)
‚îú‚îÄ‚îÄ sharded_vectors.rs  // (existant)
‚îú‚îÄ‚îÄ sharded_mappings.rs // (existant)
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ mod.rs
    ‚îú‚îÄ‚îÄ search_tests.rs
    ‚îú‚îÄ‚îÄ insert_tests.rs
    ‚îú‚îÄ‚îÄ persistence_tests.rs
    ‚îî‚îÄ‚îÄ proptest_tests.rs
```

---

## üìã Plan d'Ex√©cution TDD S√©curis√©

### Phase 0: Pr√©paration (30min)

```powershell
# 0.1 Cr√©er branche
git checkout -b feature/v0.9.0-architecture

# 0.2 Baseline benchmarks
cargo bench --bench hnsw_benchmark -- --save-baseline pre-v090

# 0.3 Snapshot tests actuels
cargo test --package velesdb-core --lib 2>&1 | Tee-Object -FilePath tests-baseline.txt
```

### Phase 1: FT-1 - Trait HnswBackend (2h)

#### √âtape 1.1: TDD - √âcrire tests du trait

```rust
// tests/backend_trait_tests.rs
#[cfg(test)]
mod backend_trait_tests {
    use super::*;
    
    #[test]
    fn test_trait_search_signature() {
        // Le trait doit avoir search()
    }
    
    #[test]
    fn test_trait_insert_signature() {
        // Le trait doit avoir insert()
    }
    
    #[test]
    fn test_hnsw_inner_implements_backend() {
        // HnswInner doit impl√©menter le trait
    }
}
```

#### √âtape 1.2: D√©finir le trait

```rust
// backend.rs (nouveau fichier)
use hnsw_rs::prelude::Neighbour;

/// Trait abstraction for HNSW backend operations.
/// 
/// This trait allows decoupling HnswIndex from the specific
/// hnsw_rs implementation, enabling:
/// - Alternative backends
/// - Mock backends for testing
/// - Future optimizations
pub trait HnswBackend: Send + Sync {
    /// Searches the HNSW graph.
    fn search(&self, query: &[f32], k: usize, ef: usize) -> Vec<Neighbour>;
    
    /// Inserts a vector into the graph.
    fn insert(&self, data: (&[f32], usize));
    
    /// Batch parallel insert.
    fn parallel_insert(&self, data: &[(&Vec<f32>, usize)]);
    
    /// Sets searching mode.
    fn set_searching_mode(&mut self, mode: bool);
    
    /// Dumps graph to files.
    fn file_dump(&self, path: &std::path::Path, basename: &str) 
        -> std::io::Result<()>;
    
    /// Transforms raw distance to metric-appropriate score.
    fn transform_score(&self, raw_distance: f32) -> f32;
}
```

#### √âtape 1.3: Impl√©menter pour HnswInner

```rust
// Ajouter dans inner.rs ou backend.rs
impl HnswBackend for HnswInner {
    fn search(&self, query: &[f32], k: usize, ef: usize) -> Vec<Neighbour> {
        // D√©l√©guer √† l'impl√©mentation existante
        match self {
            Self::Cosine(h) => h.search(query, k, ef),
            // ...
        }
    }
    // ...
}
```

#### √âtape 1.4: Validation

```powershell
cargo test --package velesdb-core --lib
cargo clippy --all-targets --all-features -- -D warnings -D clippy::pedantic
cargo bench --bench hnsw_benchmark -- --baseline pre-v090
```

**Crit√®res GO/NO-GO**:
- [ ] Tous tests passent (657+)
- [ ] Clippy clean
- [ ] Benchmarks ¬±3% max

### Phase 2: RF-2 - Split index.rs (3h)

#### √âtape 2.1: Cr√©er accesseurs pub(super)

```rust
// Dans index.rs, ajouter AVANT le split
impl HnswIndex {
    /// Internal accessor for mappings (used by search module)
    #[inline]
    pub(super) fn mappings(&self) -> &ShardedMappings {
        &self.mappings
    }
    
    /// Internal accessor for vectors (used by search module)
    #[inline]
    pub(super) fn vectors(&self) -> &ShardedVectors {
        &self.vectors
    }
    
    /// Internal accessor for dimension
    #[inline]
    pub(super) fn dimension(&self) -> usize {
        self.dimension
    }
    
    /// Internal accessor for metric
    #[inline]
    pub(super) fn metric(&self) -> DistanceMetric {
        self.metric
    }
    
    /// Internal read lock on inner
    #[inline]
    pub(super) fn inner_read(&self) 
        -> parking_lot::RwLockReadGuard<'_, std::mem::ManuallyDrop<HnswInner>> 
    {
        self.inner.read()
    }
    
    /// Internal write lock on inner
    #[inline]
    pub(super) fn inner_write(&self) 
        -> parking_lot::RwLockWriteGuard<'_, std::mem::ManuallyDrop<HnswInner>> 
    {
        self.inner.write()
    }
}
```

#### √âtape 2.2: Extraire inner.rs

Contenu: `enum HnswInner` + `impl HnswBackend for HnswInner`

```rust
// inner.rs
use crate::distance::DistanceMetric;
use hnsw_rs::prelude::*;

pub(super) enum HnswInner {
    Cosine(Hnsw<'static, f32, DistCosine>),
    Euclidean(Hnsw<'static, f32, DistL2>),
    DotProduct(Hnsw<'static, f32, DistDot>),
    Hamming(Hnsw<'static, f32, DistL2>),
    Jaccard(Hnsw<'static, f32, DistL2>),
}

// impl blocks...
```

#### √âtape 2.3: Extraire search.rs

Contenu: `search_*`, `search_brute_force*`, `search_with_*`

```rust
// search.rs
use super::index::HnswIndex;
use super::inner::HnswInner;

impl HnswIndex {
    pub fn search(&self, query: &[f32], k: usize) -> Vec<(u64, f32)> {
        // Utiliser self.inner_read(), self.mappings(), etc.
    }
    
    // Autres m√©thodes search_*
}
```

#### √âtape 2.4: Extraire batch.rs

Contenu: `insert_batch_*`, `search_batch_*`

#### √âtape 2.5: Extraire persistence.rs

Contenu: `save()`, `load()`

**‚ö†Ô∏è ATTENTION**: `load()` contient le code `unsafe` - documenter clairement.

#### √âtape 2.6: Mettre √† jour mod.rs

```rust
// mod.rs
mod backend;
mod batch;
mod index;
mod inner;
mod mappings;
mod params;
mod persistence;
mod search;
mod sharded_mappings;
mod sharded_vectors;
mod vector_store;

// Re-exports publics
pub use backend::HnswBackend;
pub use index::HnswIndex;
pub use params::{HnswParams, SearchQuality};
```

#### √âtape 2.7: Validation apr√®s chaque extraction

```powershell
# Apr√®s CHAQUE fichier extrait
cargo check --package velesdb-core
cargo test --package velesdb-core --lib
```

### Phase 3: Validation Finale (1h)

```powershell
# 3.1 Tests complets
cargo test --package velesdb-core --all-features

# 3.2 Clippy pedantic
cargo clippy --all-targets --all-features -- -D warnings -D clippy::pedantic

# 3.3 Benchmarks r√©gression
cargo bench --bench hnsw_benchmark -- --baseline pre-v090

# 3.4 Tests proptest
cargo test --package velesdb-core proptest

# 3.5 V√©rifier structure
tree crates/velesdb-core/src/index/hnsw/
```

**Crit√®res de Release**:
- [ ] 660+ tests passent
- [ ] Clippy pedantic clean
- [ ] Benchmarks: search ¬±3%, insert ¬±5%
- [ ] Recall@10 identique (0% r√©gression)
- [ ] `index.rs` < 500 lignes

---

## üö® Rollback Plan

Si r√©gression d√©tect√©e:

```powershell
# Option 1: Revert complet
git checkout main
git branch -D feature/v0.9.0-architecture

# Option 2: Revert partiel (si merge d√©j√† fait)
git revert HEAD~N  # N = nombre de commits
```

---

## üìÖ Timeline

| Phase | Dur√©e | Checkpoints |
|-------|-------|-------------|
| Phase 0 | 30min | Branche + baseline |
| Phase 1 (FT-1) | 2h | Trait impl√©ment√© + tests |
| Phase 2 (RF-2) | 3h | Split complet + validation |
| Phase 3 | 1h | Release v0.9.0 |
| **Total** | **6.5h** | |

---

## ‚úÖ Validation Panel Expert

| Expert | Approbation Plan |
|--------|------------------|
| üèóÔ∏è Architecte | ‚úÖ Approuv√© |
| ‚ö° Performance | ‚úÖ Approuv√© avec seuils |
| üîí S√©curit√© | ‚úÖ Approuv√© (Drop rule) |
| üìê Clean Code | ‚úÖ Approuv√© |
| üß™ Testabilit√© | ‚úÖ Approuv√© |
| üìö Documentation | ‚úÖ Approuv√© |
| üîß Maintenabilit√© | ‚úÖ Approuv√© |

**Date validation**: 2026-01-03  
**Prochaine action**: Cr√©er branche `feature/v0.9.0-architecture`
