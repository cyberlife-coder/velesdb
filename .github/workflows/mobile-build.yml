# =============================================================================
# VelesDB Mobile - Build Workflow for iOS and Android
# =============================================================================
# Builds UniFFI bindings for mobile platforms:
# - iOS: aarch64-apple-ios, aarch64-apple-ios-sim, x86_64-apple-ios
# - Android: aarch64-linux-android, armv7-linux-androideabi, x86_64-linux-android
# =============================================================================

name: Mobile Build

on:
  push:
    branches: [main, develop]
    paths:
      - 'crates/velesdb-mobile/**'
      - 'crates/velesdb-core/**'
      - '.github/workflows/mobile-build.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'crates/velesdb-mobile/**'
      - 'crates/velesdb-core/**'
  workflow_dispatch:
    inputs:
      generate_bindings:
        description: 'Generate UniFFI bindings (Swift/Kotlin)'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  # ===========================================================================
  # Check velesdb-mobile compiles
  # ===========================================================================
  check:
    name: Check Mobile Crate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "mobile-check"

      - name: Check velesdb-mobile
        run: cargo check -p velesdb-mobile

      - name: Clippy velesdb-mobile
        run: cargo clippy -p velesdb-mobile -- -D warnings

  # ===========================================================================
  # iOS Build (macOS runner required)
  # ===========================================================================
  ios:
    name: iOS Build
    runs-on: macos-latest
    needs: check
    strategy:
      matrix:
        target:
          - aarch64-apple-ios        # Device (ARM64)
          - aarch64-apple-ios-sim    # Simulator (ARM64 - Apple Silicon)
          - x86_64-apple-ios         # Simulator (Intel)
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "ios-${{ matrix.target }}"

      - name: Build for ${{ matrix.target }}
        run: cargo build --release --target ${{ matrix.target }} -p velesdb-mobile

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/libvelesdb_mobile.a
          retention-days: 7

  # ===========================================================================
  # Android Build (Linux runner with NDK)
  # ===========================================================================
  android:
    name: Android Build
    runs-on: ubuntu-latest
    needs: check
    strategy:
      matrix:
        target:
          - aarch64-linux-android    # ARM64 devices (most modern phones)
          - armv7-linux-androideabi  # ARMv7 devices (older phones)
          - x86_64-linux-android     # x86_64 emulator
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "android-${{ matrix.target }}"

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26b
          add-to-path: true

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Build for ${{ matrix.target }}
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          cargo ndk -t ${{ matrix.target }} build --release -p velesdb-mobile

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/libvelesdb_mobile.so
          retention-days: 7

  # ===========================================================================
  # Generate UniFFI Bindings (manual trigger only)
  # ===========================================================================
  generate-bindings:
    name: Generate UniFFI Bindings
    runs-on: macos-latest
    needs: [ios, android]
    if: github.event.inputs.generate_bindings == 'true' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "bindings"

      - name: Build for iOS (for bindgen)
        run: cargo build --release --target aarch64-apple-ios -p velesdb-mobile

      - name: Generate Swift bindings
        run: |
          mkdir -p bindings/swift
          # UniFFI bindings generated via build.rs - copy scaffolding files
          echo "UniFFI bindings will be generated at build time via proc-macro" > bindings/swift/README.md

      - name: Generate Kotlin bindings
        run: |
          mkdir -p bindings/kotlin
          # UniFFI bindings generated via build.rs - copy scaffolding files
          echo "UniFFI bindings will be generated at build time via proc-macro" > bindings/kotlin/README.md

      - name: Upload bindings
        uses: actions/upload-artifact@v4
        with:
          name: uniffi-bindings
          path: bindings/
          retention-days: 30

  # ===========================================================================
  # Summary
  # ===========================================================================
  mobile-success:
    name: Mobile Build Success
    runs-on: ubuntu-latest
    needs: [check, ios, android]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.check.result }}" != "success" ] || \
             [ "${{ needs.ios.result }}" != "success" ] || \
             [ "${{ needs.android.result }}" != "success" ]; then
            echo "‚ùå Mobile build failed"
            exit 1
          fi
          echo "‚úÖ Mobile build passed"
          echo ""
          echo "üì± iOS targets built:"
          echo "  - aarch64-apple-ios (device)"
          echo "  - aarch64-apple-ios-sim (simulator ARM)"
          echo "  - x86_64-apple-ios (simulator Intel)"
          echo ""
          echo "ü§ñ Android targets built:"
          echo "  - aarch64-linux-android (ARM64)"
          echo "  - armv7-linux-androideabi (ARMv7)"
          echo "  - x86_64-linux-android (x86_64)"
