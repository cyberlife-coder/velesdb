name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.8.5)'
        required: true
        type: string
      publish_binaries:
        description: 'Build binaries'
        type: boolean
        default: true
      publish_crates:
        description: 'Publish to crates.io'
        type: boolean
        default: true
      publish_pypi:
        description: 'Publish to PyPI'
        type: boolean
        default: true
      publish_npm:
        description: 'Publish to npm'
        type: boolean
        default: true
      publish_github:
        description: 'Create GitHub Release'
        type: boolean
        default: true

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUST_VERSION: '1.83'

jobs:
  # ===========================================================================
  # 1. Validate & Extract Version
  # ===========================================================================
  validate:
    name: Validate
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Extract version
        id: version
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            VERSION="$INPUT_VERSION"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          [[ "$VERSION" == *"-"* ]] && echo "is_prerelease=true" >> $GITHUB_OUTPUT || echo "is_prerelease=false" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

  # ===========================================================================
  # 2. Build Binaries (Linux, Windows, macOS)
  # ===========================================================================
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    needs: validate
    if: github.event_name == 'push' || inputs.publish_binaries
    strategy:
      fail-fast: false
      matrix:
        include:
          - { target: x86_64-unknown-linux-gnu, os: ubuntu-latest, ext: tar.gz }
          - { target: x86_64-pc-windows-msvc, os: windows-latest, ext: zip }
          - { target: aarch64-apple-darwin, os: macos-latest, ext: tar.gz }
          - { target: x86_64-apple-darwin, os: macos-latest, ext: tar.gz }

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable # Intentionally unpinned - uses toolchain input
        with:
          toolchain: ${{ env.RUST_VERSION }}
      
      - name: Add target
        run: rustup target add ${{ matrix.target }}

      - name: Cache apt packages (Linux)
        if: runner.os == 'Linux'
        uses: awalsh128/cache-apt-pkgs-action@acb598e5ddbc6f68a970c5da0688d2f3a9f04d05 # v1.6.0
        with:
          packages: libglib2.0-dev libgtk-3-dev libwebkit2gtk-4.1-dev
          version: 1.0

      - uses: Swatinem/rust-cache@401aff9a7a08acb9d27b64936a90db81024cff97 # v2.8.2
        with:
          shared-key: "release-${{ matrix.target }}"

      - name: Install cargo-deb (Linux)
        if: runner.os == 'Linux'
        run: cargo install cargo-deb --locked

      - name: Build
        run: cargo build --release --target ${{ matrix.target }} -p velesdb-cli -p velesdb-server -p velesdb-migrate

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir dist && cp target/${{ matrix.target }}/release/velesdb target/${{ matrix.target }}/release/velesdb-server target/${{ matrix.target }}/release/velesdb-migrate dist/ 2>/dev/null || true
          cp README.md LICENSE dist/
          tar -czvf velesdb-${{ matrix.target }}.${{ matrix.ext }} -C dist .

      - name: Package (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir dist
          Copy-Item target/${{ matrix.target }}/release/*.exe dist/ -ErrorAction SilentlyContinue
          Copy-Item README.md,LICENSE dist/
          Compress-Archive -Path dist/* -DestinationPath velesdb-${{ matrix.target }}.${{ matrix.ext }}

      - name: Build .deb (Linux)
        if: runner.os == 'Linux'
        run: |
          cargo deb -p velesdb-cli --no-build --target ${{ matrix.target }}
          cp target/${{ matrix.target }}/debian/*.deb velesdb-${{ needs.validate.outputs.version }}-amd64.deb

      - uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: binaries-${{ matrix.target }}
          path: |
            *.tar.gz
            *.zip
            *.deb

  # ===========================================================================
  # 3. Publish to crates.io (each crate independently)
  # ===========================================================================
  publish-crates:
    name: Publish ${{ matrix.crate }}
    runs-on: ubuntu-latest
    needs: validate
    if: |
      needs.validate.outputs.is_prerelease == 'false' &&
      (github.event_name == 'push' || inputs.publish_crates)
    environment: crates-io
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        crate:
          - velesdb-core
          - velesdb-server
          - velesdb-cli
          - velesdb-migrate
          - velesdb-mobile
          - tauri-plugin-velesdb
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: dtolnay/rust-toolchain@stable # Intentionally unpinned - uses toolchain input

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@acb598e5ddbc6f68a970c5da0688d2f3a9f04d05 # v1.6.0
        with:
          packages: libglib2.0-dev libgtk-3-dev libwebkit2gtk-4.1-dev
          version: 1.0

      - uses: Swatinem/rust-cache@401aff9a7a08acb9d27b64936a90db81024cff97 # v2.8.2
        with:
          shared-key: "publish-crates"

      - name: Publish ${{ matrix.crate }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "ðŸ“¦ Publishing ${{ matrix.crate }}..."
          cargo publish -p ${{ matrix.crate }} --allow-dirty || echo "â­ï¸ ${{ matrix.crate }} already published or failed"

  # ===========================================================================
  # 4. Publish to PyPI (each package independently)
  # ===========================================================================
  publish-pypi:
    name: Publish PyPI ${{ matrix.package }}
    runs-on: ubuntu-latest
    needs: validate
    if: |
      needs.validate.outputs.is_prerelease == 'false' &&
      (github.event_name == 'push' || inputs.publish_pypi)
    environment: pypi
    strategy:
      fail-fast: false
      matrix:
        package:
          - velesdb
          - langchain-velesdb
          - llamaindex-velesdb
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.11'

      - name: Setup Rust (velesdb only)
        if: matrix.package == 'velesdb'
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Build velesdb wheel
        if: matrix.package == 'velesdb'
        env:
          PYTHONHOME: ""
          PYTHONPATH: ""
        run: |
          pip install maturin
          cd crates/velesdb-python
          maturin build --release --out dist

      - name: Publish velesdb to PyPI
        if: matrix.package == 'velesdb'
        uses: pypa/gh-action-pypi-publish@76f52bc884231f62b9a034ebfe128415bbaabdfc # release/v1
        with:
          packages-dir: crates/velesdb-python/dist/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

      - name: Build langchain-velesdb
        if: matrix.package == 'langchain-velesdb'
        run: |
          cd integrations/langchain
          pip install build
          python -m build

      - name: Publish langchain-velesdb to PyPI
        if: matrix.package == 'langchain-velesdb'
        uses: pypa/gh-action-pypi-publish@76f52bc884231f62b9a034ebfe128415bbaabdfc # release/v1
        with:
          packages-dir: integrations/langchain/dist/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

      - name: Build llamaindex-velesdb
        if: matrix.package == 'llamaindex-velesdb'
        run: |
          cd integrations/llamaindex
          pip install build hatchling
          python -m build

      - name: Publish llamaindex-velesdb to PyPI
        if: matrix.package == 'llamaindex-velesdb'
        uses: pypa/gh-action-pypi-publish@76f52bc884231f62b9a034ebfe128415bbaabdfc # release/v1
        with:
          packages-dir: integrations/llamaindex/dist/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

  # ===========================================================================
  # 5. Publish to npm (each package independently)
  # ===========================================================================
  publish-npm:
    name: Publish npm ${{ matrix.package }}
    runs-on: ubuntu-latest
    needs: validate
    if: |
      needs.validate.outputs.is_prerelease == 'false' &&
      (github.event_name == 'push' || inputs.publish_npm)
    environment: npm
    strategy:
      fail-fast: false
      matrix:
        package:
          - wasm
          - typescript-sdk
          - tauri-plugin
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Rust (wasm only)
        if: matrix.package == 'wasm'
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        if: matrix.package == 'wasm'
        run: cargo install wasm-pack --locked

      - name: Build & Publish WASM
        if: matrix.package == 'wasm'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd crates/velesdb-wasm
          wasm-pack build --target web --release
          cd pkg
          VERSION=${{ needs.validate.outputs.version }}
          node -e "const p=require('./package.json'); p.name='@wiscale/velesdb-wasm'; p.version='$VERSION'; require('fs').writeFileSync('package.json',JSON.stringify(p,null,2))"
          npm publish --access public || echo "â­ï¸ WASM already published"

      - name: Build & Publish TypeScript SDK
        if: matrix.package == 'typescript-sdk'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd sdks/typescript
          npm install && npm run build
          npm publish --access public || echo "â­ï¸ SDK already published"

      - name: Build & Publish Tauri Plugin
        if: matrix.package == 'tauri-plugin'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd crates/tauri-plugin-velesdb/guest-js
          npm install && npm run build
          npm publish --access public || echo "â­ï¸ Tauri plugin already published"

  # ===========================================================================
  # 6. Create GitHub Release
  # ===========================================================================
  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: |
      always() &&
      needs.validate.result == 'success' &&
      (github.event_name == 'push' || inputs.publish_github) &&
      (needs.build.result == 'success' || needs.build.result == 'skipped')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: artifacts
          pattern: binaries-*
          merge-multiple: true

      - name: Generate changelog
        run: |
          echo "## What's Changed" > RELEASE_NOTES.md
          PREV=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          [ -n "$PREV" ] && git log --pretty="- %s" $PREV..HEAD >> RELEASE_NOTES.md || echo "- Initial release" >> RELEASE_NOTES.md

      - name: Create Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          name: VelesDB v${{ needs.validate.outputs.version }}
          body_path: RELEASE_NOTES.md
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          files: artifacts/*
          generate_release_notes: true

  # ===========================================================================
  # 7. Summary
  # ===========================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [validate, build, publish-crates, publish-pypi, publish-npm, github-release]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Release v${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Binaries | ${{ needs.build.result == 'success' && 'âœ…' || (needs.build.result == 'skipped' && 'â­ï¸' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| crates.io | ${{ needs.publish-crates.result == 'success' && 'âœ…' || (needs.publish-crates.result == 'skipped' && 'â­ï¸' || 'âš ï¸') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PyPI | ${{ needs.publish-pypi.result == 'success' && 'âœ…' || (needs.publish-pypi.result == 'skipped' && 'â­ï¸' || 'âš ï¸') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| npm | ${{ needs.publish-npm.result == 'success' && 'âœ…' || (needs.publish-npm.result == 'skipped' && 'â­ï¸' || 'âš ï¸') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.github-release.result == 'success' && 'âœ…' || (needs.github-release.result == 'skipped' && 'â­ï¸' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Re-run Options" >> $GITHUB_STEP_SUMMARY
          echo "Use **workflow_dispatch** to re-run specific components without re-tagging:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Select only failed components" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Each crate/package runs independently" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… fail-fast: false - one failure doesn't block others" >> $GITHUB_STEP_SUMMARY
