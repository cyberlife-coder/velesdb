# =============================================================================
# VelesDB Core - Release & Publication Workflow
# =============================================================================
# DÃ©clenchÃ© par tag v* uniquement.
# 
# StratÃ©gie : Le tag pointe vers un commit qui a dÃ©jÃ  passÃ© CI sur main.
# On ne refait PAS les tests, on build et publie directement.
#
# Publications :
# - crates.io (velesdb-core, velesdb-server, velesdb-cli, tauri-plugin)
# - GitHub Release (binaries Linux/Windows)
# - PyPI (via pypi-publish.yml, dÃ©clenchÃ© par release)
# - npm (via wasm-publish.yml, dÃ©clenchÃ© par release)
# =============================================================================

name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'  # Pre-releases (v1.0.0-beta.1)

env:
  CARGO_TERM_COLOR: always

jobs:
  # ===========================================================================
  # Validation du tag
  # ===========================================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if [[ "$VERSION" == *"-"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi
          echo "ðŸ“¦ Version: $VERSION"

      - name: Verify Cargo.toml matches tag
        run: |
          CARGO_VERSION=$(grep -m1 'version = ' Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          if [ "$CARGO_VERSION" != "${{ steps.version.outputs.version }}" ]; then
            echo "âŒ Version mismatch: Cargo.toml ($CARGO_VERSION) != tag (${{ steps.version.outputs.version }})"
            exit 1
          fi
          echo "âœ… Version: $CARGO_VERSION"

  # ===========================================================================
  # Build release binaries (multi-platform)
  # ===========================================================================
  build-binaries:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            artifact: velesdb-linux-x86_64
            ext: tar.gz
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            artifact: velesdb-windows-x86_64
            ext: zip
          # macOS dÃ©sactivÃ© (anndists AVX2 x86 only)

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-dev libgtk-3-dev libwebkit2gtk-4.1-dev

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "release-${{ matrix.target }}"

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/velesdb dist/ 2>/dev/null || true
          cp target/${{ matrix.target }}/release/velesdb-server dist/ 2>/dev/null || true
          cp target/${{ matrix.target }}/release/velesdb-cli dist/ 2>/dev/null || true
          cp README.md LICENSE dist/
          tar -czvf ${{ matrix.artifact }}.${{ matrix.ext }} -C dist .

      - name: Package (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir dist
          Copy-Item target/${{ matrix.target }}/release/*.exe dist/ -ErrorAction SilentlyContinue
          Copy-Item README.md,LICENSE dist/
          Compress-Archive -Path dist/* -DestinationPath ${{ matrix.artifact }}.${{ matrix.ext }}

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: "*.${{ matrix.ext }}"

  # ===========================================================================
  # Publish to crates.io (stable releases only)
  # ===========================================================================
  publish-crates:
    name: Publish crates.io
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.is_prerelease == 'false'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Publish crates (ordered by dependency)
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          # Order matters: dependencies first
          for crate in velesdb-core velesdb-server velesdb-cli tauri-plugin-velesdb; do
            echo "ðŸ“¦ Publishing $crate..."
            cargo publish -p $crate --allow-dirty || echo "âš ï¸ $crate: already published or error"
            sleep 30  # Wait for crates.io index
          done

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build-binaries]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate changelog
        run: |
          echo "## What's Changed" > CHANGELOG.md
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> CHANGELOG.md
          else
            echo "- Initial release" >> CHANGELOG.md
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: VelesDB v${{ needs.validate.outputs.version }}
          body_path: CHANGELOG.md
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
          generate_release_notes: true

  # ===========================================================================
  # Notify downstream (Premium repo + trigger PyPI/npm via release event)
  # ===========================================================================
  notify:
    name: Notify Downstream
    runs-on: ubuntu-latest
    needs: [validate, create-release]
    if: needs.validate.outputs.is_prerelease == 'false'
    steps:
      - name: Trigger velesdb-private update
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.PREMIUM_REPO_TOKEN }}
          repository: cyberlife-coder/velesdb-private
          event-type: core-release
          client-payload: '{"version": "${{ needs.validate.outputs.version }}"}'
        continue-on-error: true

      # PyPI et npm sont dÃ©clenchÃ©s automatiquement par l'event "release: published"
      # via pypi-publish.yml et wasm-publish.yml

  # ===========================================================================
  # Summary
  # ===========================================================================
  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [validate, build-binaries, publish-crates, create-release]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release:** ${{ needs.validate.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Binaries | ${{ needs.build-binaries.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| crates.io | ${{ needs.publish-crates.result == 'success' && 'âœ…' || (needs.publish-crates.result == 'skipped' && 'â­ï¸ skipped' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.create-release.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PyPI | â³ triggered by release |" >> $GITHUB_STEP_SUMMARY
          echo "| npm (WASM) | â³ triggered by release |" >> $GITHUB_STEP_SUMMARY
