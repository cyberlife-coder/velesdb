name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.8.5)'
        required: true
        type: string

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUST_VERSION: '1.83'

jobs:
  # ===========================================================================
  # 1. Validate & Extract Version
  # ===========================================================================
  validate:
    name: Validate
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          [[ "$VERSION" == *"-"* ]] && echo "is_prerelease=true" >> $GITHUB_OUTPUT || echo "is_prerelease=false" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

  # ===========================================================================
  # 2. Build Binaries (Linux, Windows, macOS)
  # ===========================================================================
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        include:
          - { target: x86_64-unknown-linux-gnu, os: ubuntu-latest, ext: tar.gz }
          - { target: x86_64-pc-windows-msvc, os: windows-latest, ext: zip }
          - { target: aarch64-apple-darwin, os: macos-latest, ext: tar.gz }
          - { target: x86_64-apple-darwin, os: macos-latest, ext: tar.gz }

    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
      
      - name: Add target
        run: rustup target add ${{ matrix.target }}

      - name: Cache apt packages (Linux)
        if: runner.os == 'Linux'
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libglib2.0-dev libgtk-3-dev libwebkit2gtk-4.1-dev
          version: 1.0

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release-${{ matrix.target }}"

      - name: Install cargo-deb (Linux)
        if: runner.os == 'Linux'
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deb

      - name: Build
        run: cargo build --release --target ${{ matrix.target }} -p velesdb-cli -p velesdb-server -p velesdb-migrate

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir dist && cp target/${{ matrix.target }}/release/velesdb target/${{ matrix.target }}/release/velesdb-server target/${{ matrix.target }}/release/velesdb-migrate dist/ 2>/dev/null || true
          cp README.md LICENSE dist/
          tar -czvf velesdb-${{ matrix.target }}.${{ matrix.ext }} -C dist .

      - name: Package (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir dist
          Copy-Item target/${{ matrix.target }}/release/*.exe dist/ -ErrorAction SilentlyContinue
          Copy-Item README.md,LICENSE dist/
          Compress-Archive -Path dist/* -DestinationPath velesdb-${{ matrix.target }}.${{ matrix.ext }}

      - name: Build .deb (Linux)
        if: runner.os == 'Linux'
        run: |
          cargo deb -p velesdb-cli --no-build --target ${{ matrix.target }}
          cp target/${{ matrix.target }}/debian/*.deb velesdb-${{ needs.validate.outputs.version }}-amd64.deb

      - uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.target }}
          path: |
            *.tar.gz
            *.zip
            *.deb

  # ===========================================================================
  # 3. Publish to crates.io
  # ===========================================================================
  publish-crates:
    name: Publish crates.io
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.is_prerelease == 'false'
    environment: crates-io
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libglib2.0-dev libgtk-3-dev libwebkit2gtk-4.1-dev
          version: 1.0

      - name: Publish (ordered by deps)
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          for crate in velesdb-core velesdb-server velesdb-cli velesdb-migrate velesdb-mobile tauri-plugin-velesdb; do
            echo "ðŸ“¦ Publishing $crate..."
            cargo publish -p $crate --allow-dirty 2>/dev/null || echo "â­ï¸ $crate already published"
            sleep 10
          done

  # ===========================================================================
  # 4. Publish to PyPI
  # ===========================================================================
  publish-pypi:
    name: Publish PyPI
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.is_prerelease == 'false'
    environment: pypi
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Build wheel
        env:
          # Clear any cached/polluted Python paths to avoid cross-platform issues
          PYTHONHOME: ""
          PYTHONPATH: ""
        run: |
          pip install maturin
          cd crates/velesdb-python
          maturin build --release --out dist

      - name: Publish velesdb to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: crates/velesdb-python/dist/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

      # LangChain Integration
      - name: Build & Publish langchain-velesdb
        run: |
          cd integrations/langchain
          pip install build
          python -m build
        continue-on-error: true

      - name: Publish langchain-velesdb to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: integrations/langchain/dist/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
        continue-on-error: true

      # LlamaIndex Integration
      - name: Build & Publish llama-index-vector-stores-velesdb
        run: |
          cd integrations/llamaindex
          pip install build hatchling
          python -m build
        continue-on-error: true

      - name: Publish llama-index-vector-stores-velesdb to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: integrations/llamaindex/dist/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
        continue-on-error: true

  # ===========================================================================
  # 5. Publish to npm (WASM + SDK)
  # ===========================================================================
  publish-npm:
    name: Publish npm
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.is_prerelease == 'false'
    environment: npm
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - uses: taiki-e/install-action@v2
        with:
          tool: wasm-pack

      # WASM package
      - name: Build & Publish WASM
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd crates/velesdb-wasm
          wasm-pack build --target web --release
          cd pkg
          VERSION=${{ needs.validate.outputs.version }}
          node -e "const p=require('./package.json'); p.name='@wiscale/velesdb-wasm'; p.version='$VERSION'; require('fs').writeFileSync('package.json',JSON.stringify(p,null,2))"
          npm publish --access public || echo "â­ï¸ WASM already published"

      # TypeScript SDK
      - name: Build & Publish SDK
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd sdks/typescript
          npm install && npm run build
          npm publish --access public || echo "â­ï¸ SDK already published"

      # Tauri Plugin
      - name: Build & Publish Tauri Plugin
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd crates/tauri-plugin-velesdb/guest-js
          npm install && npm run build
          npm publish --access public || echo "â­ï¸ Tauri plugin already published"

  # ===========================================================================
  # 6. Create GitHub Release
  # ===========================================================================
  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: binaries-*
          merge-multiple: true

      - name: Generate changelog
        run: |
          echo "## What's Changed" > RELEASE_NOTES.md
          PREV=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          [ -n "$PREV" ] && git log --pretty="- %s" $PREV..HEAD >> RELEASE_NOTES.md || echo "- Initial release" >> RELEASE_NOTES.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: VelesDB v${{ needs.validate.outputs.version }}
          body_path: RELEASE_NOTES.md
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          files: artifacts/*
          generate_release_notes: true

  # ===========================================================================
  # 7. Summary
  # ===========================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [validate, build, publish-crates, publish-pypi, publish-npm, github-release]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Release v${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Binaries | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| crates.io | ${{ needs.publish-crates.result == 'success' && 'âœ…' || 'â­ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PyPI | ${{ needs.publish-pypi.result == 'success' && 'âœ…' || 'â­ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| npm | ${{ needs.publish-npm.result == 'success' && 'âœ…' || 'â­ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.github-release.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
