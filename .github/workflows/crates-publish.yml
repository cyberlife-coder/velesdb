name: Crates.io Publish

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual publish)'
        required: false
        default: 'false'
        type: boolean

env:
  RUST_VERSION: '1.83'
  CARGO_TERM_COLOR: always

jobs:
  publish-tauri-plugin:
    name: Publish tauri-plugin-velesdb
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Verify package
        working-directory: integrations/tauri-plugin-velesdb
        run: |
          cargo check
          cargo package --list

      - name: Publish to crates.io (dry run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        working-directory: integrations/tauri-plugin-velesdb
        run: cargo publish --dry-run

      - name: Publish to crates.io
        if: ${{ github.event.inputs.dry_run != 'true' }}
        working-directory: integrations/tauri-plugin-velesdb
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish

  verify-installation:
    name: Verify crates.io installation
    needs: publish-tauri-plugin
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.dry_run != 'true' }}
    steps:
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Wait for crates.io propagation
        run: sleep 30

      - name: Test installation from crates.io
        run: |
          cargo install --list
          # Just verify the crate is accessible
          cargo search tauri-plugin-velesdb
